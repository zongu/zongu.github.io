<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description"><meta name="keywords" content="kubernets"><title>Mongodb-Cluster - Carter`s Blog</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/favicon.ico"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com/zongu"><span>Github</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="/img/galaxy02.jpg"><div class="post-title"><h1 class="title">Mongodb-Cluster</h1><ul class="meta"><li><i class="icon icon-author"></i>Carter Ho</li><li><i class="icon icon-clock"></i>13 Minutes</li><li><i class="icon icon-calendar"></i>2019年10月2日</li></ul></div></div><div class="article-content" style="max-width:800px"><h2 id="Replica-Set-副本集"><a href="#Replica-Set-副本集" class="headerlink" title="Replica Set(副本集):"></a>Replica Set(副本集):</h2><ul>
<li>Replca Set Primary:以Primary為首要負責讀寫，其餘節點作為輔助負責複製操作日誌，當Primary發生問題時會由其餘節點投票選出一位做為Primary<br><img src="rs1.svg" alt></li>
<li>Replca Set Secondary Members:同Replca Set Primary，但輔助成員可供讀<br><img src="rs2.svg" alt></li>
<li>Replca Set Arbiter:仲裁不儲存數據專職處理Primary選擇<br><img src="rs3.svg" alt></li>
</ul>
<h2 id="Sharded-Cluster-分片"><a href="#Sharded-Cluster-分片" class="headerlink" title="Sharded Cluster(分片):"></a>Sharded Cluster(分片):</h2><ul>
<li>Shards: 2個或以上組成分片群，附載平衡資料用，降低壓力避免都在同一個RS，可水平擴展</li>
<li>Config Servers: 由RS組成，紀錄Metadata</li>
<li>Router: 1個或以上組成，可水平擴展分散來自ap請求數量<br><img src="sh.svg" alt></li>
</ul>
<h2 id="docker-建立分片"><a href="#docker-建立分片" class="headerlink" title="docker 建立分片"></a>docker 建立分片</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"># 準備auth用的keyfile，並組裝成image(這部分也可以用mount的方式替代)</span><br><span class="line"># Dockerfile腳本</span><br><span class="line">## 基礎版本</span><br><span class="line">FROM mongo:4.2.0</span><br><span class="line">## 複製設定檔</span><br><span class="line">COPY ./keyfile /opt/</span><br><span class="line">RUN bash -c &apos;chmod 600 /opt/keyfile&apos;</span><br><span class="line">RUN bash -c &apos;chown 999 /opt/keyfile&apos;</span><br><span class="line">USER root</span><br><span class="line"></span><br><span class="line"># 建立容器私有網段</span><br><span class="line">docker network create --subnet=10.100.0.0/16 mongo</span><br><span class="line"></span><br><span class="line"># 加入容器內往IP網段</span><br><span class="line">route add 10.100.0.0 MASK 255.255.255.0 10.0.75.2</span><br><span class="line"></span><br><span class="line"># 若是在Windows須將mongodb mount到獨立的volume，若直接monut在宿主實體路徑會有檔案權限問題</span><br><span class="line"># config server rs volumes</span><br><span class="line">docker volume create csrs1</span><br><span class="line">docker volume create csrs2</span><br><span class="line">docker volume create csrs3</span><br><span class="line"># router volumes</span><br><span class="line">docker volume create mongos1</span><br><span class="line">docker volume create mongos2</span><br><span class="line"># shard1 rs volumes</span><br><span class="line">docker volume create sh1rs1</span><br><span class="line">docker volume create sh1rs2</span><br><span class="line">docker volume create sh1rs3</span><br><span class="line"># shard2 rs volumes</span><br><span class="line">docker volume create sh2rs1</span><br><span class="line">docker volume create sh2rs2</span><br><span class="line">docker volume create sh2rs3</span><br><span class="line"></span><br><span class="line"># 分片群集之間auth須由特定keyfile組成，在keyfile加入前須先設定好user跟CSRS還有SHRS設定，一開始先註解掉--keyfile指令</span><br><span class="line"># config server rs volumes</span><br><span class="line">docker run -d --network mongo --ip 10.100.0.2 -v csrs1:/data/configdb --name csrs1 --hostname 10.100.0.2 -e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot; mongo:custom mongod --keyFile /opt/keyfile --configsvr --replSet csrs --port 27017 --oplogSize 16</span><br><span class="line">docker run -d --network mongo --ip 10.100.0.3 -v csrs2:/data/configdb --name csrs2 -e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot; mongo:custom mongod --keyFile /opt/keyfile --configsvr --replSet csrs --port 27017 --oplogSize 16</span><br><span class="line">docker run -d --network mongo --ip 10.100.0.4 -v csrs3:/data/configdb --name csrs3 -e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot; mongo:custom mongod --keyFile /opt/keyfile --configsvr --replSet csrs --port 27017 --oplogSize 16</span><br><span class="line"># router volumes</span><br><span class="line"># 這邊要注意啟動時要指定bind_ip，否則預設為localhost會無法expose</span><br><span class="line">docker run -d --network mongo --ip 10.100.0.5 -v mongos1:/data/db --name mongos1 -e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot; mongo:custom mongos --keyFile /opt/keyfile --configdb csrs/10.100.0.2:27017,10.100.0.3:27017,10.100.0.4:27017 --bind_ip 10.100.0.5</span><br><span class="line">docker run -d --network mongo --ip 10.100.0.6 -v mongos2:/data/db --name mongos1 -e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot; mongo:custom mongos --keyFile /opt/keyfile --configdb csrs/10.100.0.2:27017,10.100.0.3:27017,10.100.0.4:27017 --bind_ip 10.100.0.6</span><br><span class="line"># 因為mongo跑起來時conf host名稱預設會帶containerId所以這邊先指定給容器內往IP，不然宿主在連副本集會找不到該hostname</span><br><span class="line"># shard1 rs volumes</span><br><span class="line">docker run -d --network mongo --ip 10.100.0.7 -v sh1rs1:/data/db --hostname 10.100.0.7 --name sh1rs1 -e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot; mongo:custom mongod --keyFile /opt/keyfile --shardsvr --port 27017 --replSet sh1rs --oplogSize 16</span><br><span class="line">docker run -d --network mongo --ip 10.100.0.8 -v sh1rs2:/data/db --name sh1rs2 -e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot; mongo:custom mongod --keyFile /opt/keyfile --shardsvr --port 27017 --replSet sh1rs --oplogSize 16</span><br><span class="line">docker run -d --network mongo --ip 10.100.0.9 -v sh1rs3:/data/db --name sh1rs3 -e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot; mongo:custom mongod --keyFile /opt/keyfile --shardsvr --port 27017 --replSet sh1rs --oplogSize 16</span><br><span class="line"># shard2 rs volumes</span><br><span class="line">docker run -d --network mongo --ip 10.100.0.10 -v sh2rs1:/data/db --hostname 10.100.0.10 --name sh2rs1 -e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot; mongo:custom mongod --keyFile /opt/keyfile --shardsvr --port 27017 --replSet sh2rs --oplogSize 16</span><br><span class="line">docker run -d --network mongo --ip 10.100.0.11 -v sh2rs2:/data/db --name sh2rs2 -e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot; mongo:custom mongod --keyFile /opt/keyfile --shardsvr --port 27017 --replSet sh2rs --oplogSize 16</span><br><span class="line">docker run -d --network mongo --ip 10.100.0.12 -v sh2rs3:/data/db --name sh2rs3 -e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot; mongo:custom mongod --keyFile /opt/keyfile --shardsvr --port 27017 --replSet sh2rs --oplogSize 16</span><br><span class="line"></span><br><span class="line"># 設定 config server</span><br><span class="line">docker exec -it scrs1 bash</span><br><span class="line">mongo</span><br><span class="line">rs.initiate()</span><br><span class="line">rs.add(&apos;10.100.0.3:27017&apos;)</span><br><span class="line">rs.add(&apos;10.100.0.4:27017&apos;)</span><br><span class="line">use admin</span><br><span class="line">db.createUser(&#123;user:&quot;root&quot;,pwd:&quot;123456&quot;,roles:[&#123;role:&quot;root&quot;,db:&quot;admin&quot;&#125;]&#125;)</span><br><span class="line">db.createUser(&#123;user:&quot;admin&quot;,pwd:&quot;123456&quot;,roles:[&#123;role:&quot;userAdminAnyDatabase&quot;,db:&quot;admin&quot;&#125;]&#125;)</span><br><span class="line">db.createUser(&#123;user:&quot;user&quot;,pwd:&quot;123456&quot;,roles:[&#123;&quot;role&quot;:&quot;readWriteAnyDatabase&quot;,&quot;db&quot;:&quot;admin&quot;&#125;]&#125;)</span><br><span class="line"></span><br><span class="line"># 設定 shard rs 有幾個sh叢集就做幾次 以sh1為例</span><br><span class="line">docker exec -it sh1rs1 bash</span><br><span class="line">mongo</span><br><span class="line">rs.initiate()</span><br><span class="line">rs.add(&apos;10.100.0.8:27017&apos;)</span><br><span class="line">rs.addArb(&apos;10.100.0.9:27017&apos;)</span><br><span class="line">use admin</span><br><span class="line">db.createUser(&#123;user:&quot;root&quot;,pwd:&quot;123456&quot;,roles:[&#123;role:&quot;root&quot;,db:&quot;admin&quot;&#125;]&#125;)</span><br><span class="line">db.createUser(&#123;user:&quot;admin&quot;,pwd:&quot;123456&quot;,roles:[&#123;role:&quot;userAdminAnyDatabase&quot;,db:&quot;admin&quot;&#125;]&#125;)</span><br><span class="line">db.createUser(&#123;user:&quot;user&quot;,pwd:&quot;123456&quot;,roles:[&#123;&quot;role&quot;:&quot;readWriteAnyDatabase&quot;,&quot;db&quot;:&quot;admin&quot;&#125;]&#125;)</span><br><span class="line"></span><br><span class="line"># 將所有RS跟user設定完後把容器完全關閉再把原本註解的keyfile加入啟動，因為之前的設定有mont到volume所以不用擔心設定不見</span><br><span class="line"></span><br><span class="line"># 設定router 挑一台設定即可</span><br><span class="line">docker exec -it mongos1 bash</span><br><span class="line">mongo --host 10.100.0.5 --port 27017</span><br><span class="line">use admin</span><br><span class="line">db.auth(&quot;root&quot;,&quot;123456&quot;)</span><br><span class="line"># 加入shard RS &quot;RS名稱/PrimaryHost:27017&quot;</span><br><span class="line">sh.addShard(&quot;rs1/10.100.0.7:27017&quot;)</span><br><span class="line">sh.addShard(&quot;rs2/10.100.0.10:27017&quot;)</span><br><span class="line"></span><br><span class="line"># 啟動分片</span><br><span class="line"># 根據不同collection分配在不同SH</span><br><span class="line">sh.enableSharding(&quot;&lt;DataBase&gt;&quot;)</span><br><span class="line"># 將單一collection分配在不同SH做附載平衡，以hash policy為例</span><br><span class="line">sh.shardCollection(&quot;&lt;DataBase&gt;.&lt;Collection&gt;&quot;, &#123; _id: &quot;hashed&quot;&#125;)</span><br></pre></td></tr></table></figure></div><div class="article-meta" style="max-width:800px"></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2020/02/03/NodeJs-RESTful風格WebApi/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2019/09/28/MongoDb副本集/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/zongu" title="Zongu" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="https://www.facebook.com/zongyuh2" title="Zongu" target="_blank"><i class="icon icon-facebook"></i></a></li><li><a href="https://chretbow.github.io" title="Chretbow" target="_blank"><i class="icon icon-github"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2024 Carter`s Blog</p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>